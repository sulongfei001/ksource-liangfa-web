<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ksource.liangfa.mapper.SpecialActivityMapper">
  <resultMap id="BaseResultMap" type="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    <id column="ID" jdbcType="DECIMAL" property="id" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="INPUTER" jdbcType="VARCHAR" property="inputer" />
    <result column="LIANGFA_LEADER_CODE" jdbcType="DECIMAL" property="liangfaLeaderCode" />
    <result column="START_TIME" jdbcType="TIMESTAMP" property="startTime" />
    <result column="END_TIME" jdbcType="TIMESTAMP" property="endTime" />
    <result column="INPUT_TIME" jdbcType="TIMESTAMP" property="inputTime" />
    <result column="ATTACHMENT_NAME" jdbcType="VARCHAR" property="attachmentName" />
    <result column="ATTACHMENT_PATH" jdbcType="VARCHAR" property="attachmentPath" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    <result column="DETAIL_NAME" jdbcType="CLOB" property="detailName" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    ID, NAME, INPUTER, LIANGFA_LEADER_CODE, START_TIME, END_TIME, INPUT_TIME, ATTACHMENT_NAME, 
    ATTACHMENT_PATH
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    DETAIL_NAME
  </sql>
  <select id="selectByExampleWithBLOBs" parameterType="com.ksource.liangfa.domain.SpecialActivityExample" resultMap="ResultMapWithBLOBs">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from SPECIAL_ACTIVITY
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByExample" parameterType="com.ksource.liangfa.domain.SpecialActivityExample" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from SPECIAL_ACTIVITY
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="Integer" resultMap="ResultMapWithBLOBs">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from SPECIAL_ACTIVITY
    where ID = #{id,jdbcType=DECIMAL}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    delete from SPECIAL_ACTIVITY
    where ID = #{id,jdbcType=DECIMAL}
  </delete>
  <delete id="deleteByExample" parameterType="com.ksource.liangfa.domain.SpecialActivityExample">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    delete from SPECIAL_ACTIVITY
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    insert into SPECIAL_ACTIVITY (ID, NAME, INPUTER, 
      LIANGFA_LEADER_CODE, START_TIME, END_TIME, 
      INPUT_TIME, ATTACHMENT_NAME, ATTACHMENT_PATH, 
      DETAIL_NAME)
    values (#{id,jdbcType=DECIMAL}, #{name,jdbcType=VARCHAR}, #{inputer,jdbcType=VARCHAR}, 
      #{liangfaLeaderCode,jdbcType=DECIMAL}, #{startTime,jdbcType=TIMESTAMP}, #{endTime,jdbcType=TIMESTAMP}, 
      #{inputTime,jdbcType=TIMESTAMP}, #{attachmentName,jdbcType=VARCHAR}, #{attachmentPath,jdbcType=VARCHAR}, 
      #{detailName,jdbcType=CLOB})
  </insert>
  <insert id="insertSelective" parameterType="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    insert into SPECIAL_ACTIVITY
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        ID,
      </if>
      <if test="name != null">
        NAME,
      </if>
      <if test="inputer != null">
        INPUTER,
      </if>
      <if test="liangfaLeaderCode != null">
        LIANGFA_LEADER_CODE,
      </if>
      <if test="startTime != null">
        START_TIME,
      </if>
      <if test="endTime != null">
        END_TIME,
      </if>
      <if test="inputTime != null">
        INPUT_TIME,
      </if>
      <if test="attachmentName != null">
        ATTACHMENT_NAME,
      </if>
      <if test="attachmentPath != null">
        ATTACHMENT_PATH,
      </if>
      <if test="detailName != null">
        DETAIL_NAME,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=DECIMAL},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="inputer != null">
        #{inputer,jdbcType=VARCHAR},
      </if>
      <if test="liangfaLeaderCode != null">
        #{liangfaLeaderCode,jdbcType=DECIMAL},
      </if>
      <if test="startTime != null">
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="inputTime != null">
        #{inputTime,jdbcType=TIMESTAMP},
      </if>
      <if test="attachmentName != null">
        #{attachmentName,jdbcType=VARCHAR},
      </if>
      <if test="attachmentPath != null">
        #{attachmentPath,jdbcType=VARCHAR},
      </if>
      <if test="detailName != null">
        #{detailName,jdbcType=CLOB},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.ksource.liangfa.domain.SpecialActivityExample" resultType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    select count(*) from SPECIAL_ACTIVITY
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    <set>
      <if test="record.id != null">
        ID = #{record.id,jdbcType=DECIMAL},
      </if>
      <if test="record.name != null">
        NAME = #{record.name,jdbcType=VARCHAR},
      </if>
      <if test="record.inputer != null">
        INPUTER = #{record.inputer,jdbcType=VARCHAR},
      </if>
      <if test="record.liangfaLeaderCode != null">
        LIANGFA_LEADER_CODE = #{record.liangfaLeaderCode,jdbcType=DECIMAL},
      </if>
      <if test="record.startTime != null">
        START_TIME = #{record.startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.endTime != null">
        END_TIME = #{record.endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.inputTime != null">
        INPUT_TIME = #{record.inputTime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.attachmentName != null">
        ATTACHMENT_NAME = #{record.attachmentName,jdbcType=VARCHAR},
      </if>
      <if test="record.attachmentPath != null">
        ATTACHMENT_PATH = #{record.attachmentPath,jdbcType=VARCHAR},
      </if>
      <if test="record.detailName != null">
        DETAIL_NAME = #{record.detailName,jdbcType=CLOB},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExampleWithBLOBs" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    set ID = #{record.id,jdbcType=DECIMAL},
      NAME = #{record.name,jdbcType=VARCHAR},
      INPUTER = #{record.inputer,jdbcType=VARCHAR},
      LIANGFA_LEADER_CODE = #{record.liangfaLeaderCode,jdbcType=DECIMAL},
      START_TIME = #{record.startTime,jdbcType=TIMESTAMP},
      END_TIME = #{record.endTime,jdbcType=TIMESTAMP},
      INPUT_TIME = #{record.inputTime,jdbcType=TIMESTAMP},
      ATTACHMENT_NAME = #{record.attachmentName,jdbcType=VARCHAR},
      ATTACHMENT_PATH = #{record.attachmentPath,jdbcType=VARCHAR},
      DETAIL_NAME = #{record.detailName,jdbcType=CLOB}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    set ID = #{record.id,jdbcType=DECIMAL},
      NAME = #{record.name,jdbcType=VARCHAR},
      INPUTER = #{record.inputer,jdbcType=VARCHAR},
      LIANGFA_LEADER_CODE = #{record.liangfaLeaderCode,jdbcType=DECIMAL},
      START_TIME = #{record.startTime,jdbcType=TIMESTAMP},
      END_TIME = #{record.endTime,jdbcType=TIMESTAMP},
      INPUT_TIME = #{record.inputTime,jdbcType=TIMESTAMP},
      ATTACHMENT_NAME = #{record.attachmentName,jdbcType=VARCHAR},
      ATTACHMENT_PATH = #{record.attachmentPath,jdbcType=VARCHAR}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    <set>
      <if test="name != null">
        NAME = #{name,jdbcType=VARCHAR},
      </if>
      <if test="inputer != null">
        INPUTER = #{inputer,jdbcType=VARCHAR},
      </if>
      <if test="liangfaLeaderCode != null">
        LIANGFA_LEADER_CODE = #{liangfaLeaderCode,jdbcType=DECIMAL},
      </if>
      <if test="startTime != null">
        START_TIME = #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null">
        END_TIME = #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="inputTime != null">
        INPUT_TIME = #{inputTime,jdbcType=TIMESTAMP},
      </if>
      <if test="attachmentName != null">
        ATTACHMENT_NAME = #{attachmentName,jdbcType=VARCHAR},
      </if>
      <if test="attachmentPath != null">
        ATTACHMENT_PATH = #{attachmentPath,jdbcType=VARCHAR},
      </if>
      <if test="detailName != null">
        DETAIL_NAME = #{detailName,jdbcType=CLOB},
      </if>
    </set>
    where ID = #{id,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    set NAME = #{name,jdbcType=VARCHAR},
      INPUTER = #{inputer,jdbcType=VARCHAR},
      LIANGFA_LEADER_CODE = #{liangfaLeaderCode,jdbcType=DECIMAL},
      START_TIME = #{startTime,jdbcType=TIMESTAMP},
      END_TIME = #{endTime,jdbcType=TIMESTAMP},
      INPUT_TIME = #{inputTime,jdbcType=TIMESTAMP},
      ATTACHMENT_NAME = #{attachmentName,jdbcType=VARCHAR},
      ATTACHMENT_PATH = #{attachmentPath,jdbcType=VARCHAR},
      DETAIL_NAME = #{detailName,jdbcType=CLOB}
    where ID = #{id,jdbcType=DECIMAL}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.ksource.liangfa.domain.SpecialActivity">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Dec 09 17:29:10 CST 2013.
    -->
    update SPECIAL_ACTIVITY
    set NAME = #{name,jdbcType=VARCHAR},
      INPUTER = #{inputer,jdbcType=VARCHAR},
      LIANGFA_LEADER_CODE = #{liangfaLeaderCode,jdbcType=DECIMAL},
      START_TIME = #{startTime,jdbcType=TIMESTAMP},
      END_TIME = #{endTime,jdbcType=TIMESTAMP},
      INPUT_TIME = #{inputTime,jdbcType=TIMESTAMP},
      ATTACHMENT_NAME = #{attachmentName,jdbcType=VARCHAR},
      ATTACHMENT_PATH = #{attachmentPath,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=DECIMAL}
  </update>
  <!-- ======================================================================================== -->
 
	 <sql id="caseTrimField">
	  <trim>
	   where a.inputer in (
			 	select user_id from user_ where org_id in(
			 	<choose>
			 	<when test="orgIds!=null and orgIds!=''">
			 	   ${orgIds}
			 	</when>
			 	<otherwise>
			 	select member_code from activity_member where activity_id =#{id}
			 	</otherwise>
			 	</choose>
		 	))
		     
			     <![CDATA[
				       	and  a.input_time >= #{startTime,jdbcType=TIMESTAMP} and input_time  < (#{endTime,jdbcType=TIMESTAMP} +   interval   '1'  day)
				 		and a.proc_key <> 'yisongchufaProc'      	
				 ]]>
<!-- 			    <if test="procKey!=null and procKey!=''">
			        and a.proc_Key=#{procKey}
			    </if> -->
	      </trim>
   </sql>
	
   <!-- ??????????????'??????????'???????? -->
   <insert id="addActivityCase" parameterType="map">
   	     insert into activity_case(activity_id,case_id)
       select #{id},a.case_id from case_basic a 
	 	<include refid="caseTrimField" />
	 	and not exists(select 1 from activity_case ac where ac.activity_id = #{id} and ac.case_id = a.case_id)
   </insert>
   
   <!-- ???????????????'??????????'??????? -->
   <insert id="insertAcivityCase" parameterType="map">
     insert into activity_case(activity_id,case_id)
       select #{id},a.case_id from case_basic a 
	 	<include refid="caseTrimField" />
  	</insert>
  	
   <sql id="trimField">
	  <trim>
	   <if test="liangfaLeaderCode != null and liangfaLeaderCode !=''">
	      AND  LIANGFA_LEADER_CODE = #{liangfaLeaderCode}
	      </if>
	      <if test="name != null and name !=''">
	      AND  name like concat(concat('%',#{name}),'%')
	      </if>
	       <if test="orgId != null and userId!=null">
	      AND  (inputer=#{userId} or LIANGFA_LEADER_CODE=#{orgId})
	      </if>
	   </trim>
  </sql>
  <select id="find" parameterType="map" resultMap="BaseResultMap">
      select m.*,(select org_name from organise where org_code=m.liangfa_leader_code)as liangfaLeaderName
       from special_activity m
      <where>
      <include refid="trimField" />
      </where> 
      order by m.id asc
  </select>
 <resultMap extends="ResultMapWithBLOBs" id="ManualMap" type="com.ksource.liangfa.domain.SpecialActivity">
  	<collection column="id" ofType="com.ksource.liangfa.domain.ActivityMember" property="memberList" select="getMember" />
  </resultMap>
 <select id="findByPk" parameterType="int" resultMap="ManualMap">
    select m.*,(select org_name from organise where org_code=m.liangfa_leader_code)as liangfaLeaderName
       from special_activity m where id=#{id}
       order by id desc
  </select>
  <select id="getMember" parameterType="int" resultMap="com.ksource.liangfa.mapper.ActivityMemberMapper.BaseResultMap">
     select m.* ,(select org_name from organise where org_code =m.MEMBER_CODE) as memberName from activity_member m  where activity_id =#{id}
  </select>
  
  
  
  <sql id="activityCaseTrimField">
  <trim>
   	 and c.inputer in (
		 	select user_id from user_ where org_id in(
		 	<choose>
		 	<when test="orgIds!=null and orgIds!=''">
		 	   ${orgIds}
		 	</when>
		 	<otherwise>
		 	select member_code from activity_member where activity_id =#{id}
		 	</otherwise>
		 	</choose>
	 	)) 
		<![CDATA[
			and  c.input_time >= #{startTime,jdbcType=TIMESTAMP} and c.input_time  < (#{endTime,jdbcType=TIMESTAMP} +   interval   '1'  day)
			and c.proc_key <> 'yisongchufaProc'
		]]>
<!--  		<if test="procKey!=null and procKey!=''">
		     and c.proc_Key=#{procKey}
		</if>  -->
		
		order by c.latest_pocess_time desc 

	</trim>
  </sql>
  
   <select id="getActivityCaseCount" parameterType="map" resultType="int">
	 select count(1) from special_activity a,activity_case b,case_basic c where a.id = b.activity_id and b.case_id = c.case_id and a.id = #{id}
	 	<include refid="activityCaseTrimField" />
 </select>
   
  <select id="getActivityCaseList" parameterType="map" resultMap="com.ksource.liangfa.mapper.CaseBasicMapper.dqdjNumResultMap">
  	select c.* ,(select count(1) from dqdj_case_category dcc where c.case_id = dcc.case_id) dqdjNum 
  	from special_activity a,activity_case b,case_basic c where a.id = b.activity_id and b.case_id = c.case_id and a.id = #{id}
  	 <include refid="activityCaseTrimField" />
  </select>
  
  
  <select id="getSpecialActivityList" parameterType="map" resultMap="BaseResultMap">
  	select s.* from special_activity s where s.id in(select m.activity_id from activity_member m where m.member_code =  #{memberCode})  
  	<![CDATA[
      and  s.start_time < #{inputTime,jdbcType=TIMESTAMP} and (s.end_time+interval '1' day) >= #{inputTime,jdbcType=TIMESTAMP}
		]]>
  </select>
  <select id="getSpecialActivityName" resultMap="BaseResultMap">
  	SELECT T.ID,T.NAME FROM SPECIAL_ACTIVITY T ORDER BY T.ID ASC
  </select>
</mapper>